/// 首页用于保存求职者用户信息的模块
const { UserService } = require('../../service/user_service');

const Constant = require('../../common/constant');
const loading = require('../../utils/loading_util');
const $ = require('../../utils/request_util');

const app = getApp();

// 招聘人信息
const createRecruiteeData = () => ({
    realName: null,
    identityCard: null,
    gender: 0,
    // salaryList index
    salary: 0,
    expectCatagoryId: [],
    expectSalaeryMin: 0,
    expectSalaeryMax: 0,
    genderList: Constant.genderList,
    salaryList: Constant.salaryList,
});

// TODO: 输入校验
const createRecruiteeMethods = () => ({
    handleRealName: function (e) {
        var value = e.detail.value;
        this.setData({
            realName: value,
        });
    },
    handleIdentityCard: function (e) {
        var value = e.detail.value;
        this.setData({
            identityCard: value,
        });
    },
    // 选择性别
    selectGender(e) {
        let that = this;
        let index = e.currentTarget.dataset.index1;
        console.debug(`性别设置为 [${index}]: ${Constant.genderList[index]}`);
        that.setData({
            gender: index
        })
    },
    // 选择薪资
    selectSalary(e) {
        let that = this;
        let index = e.currentTarget.dataset.index3;
        console.debug(`性别设置为 [${index}]: ${Constant.salaryList[index].value}`);
        that.setData({
            salary: index
        })
    },
    // 提交信息
    _getRecruiteeInfo() {
        let data = this.data;
        let salary = Constant.salaryList[data.salary];
        return {
            // id 即是 open id
            id: wx.getStorageSync('openid'),
            realName: data.realName,
            identityCard: data.identityCard,
            gender: data.gender,
            expectSalaryMin: salary.min,
            expectSalaryMax: salary.max,
        }
    },
    commitRecruitInfo: async function () {
        let recruiteeInfo = this._getRecruiteeInfo();

        loading.begin();
        try {
            await $.request({
                url: '/user-candidate/add',
                data: recruiteeInfo,
                method: $.RequestMethod.POST,
                header: $.jsonHeader,
            });

            UserService.saveUserRole(Constant.UserRole.Recruitee);
            this.setData({
                ident: 'user'
            });
        } finally {
            loading.end();
        }


        this.setData({
            infows: true
        })
    },

    _handleRecruiteeSelected: async function () {
        try {
            loading.begin();
            let res = await UserService.loadRcruiteeInfo();
            if (!res) {
                console.debug(`服务端没有此求职者信息: ${app.getOpenid()}`);
                this.setData({
                    juesehide: true,
                    // 做实名验证
                    smhide: false,
                    ident: 'user'
                });
            } else {
                console.debug(`服务端已经有此求职者信息: ${app.getOpenid()}`);
                this.setData({
                    juesehide: true,
                    smhide: true,
                    ident: 'user',
                });
                // 保存登录角色信息
                UserService.saveUserRole(Constant.UserRole.Recruitee);
            }
        }

        catch (e) {
            console.error(e);
        }
        finally {
            loading.end();
        }
    }
});

module.exports = {
    createRecruiteeMethods: createRecruiteeMethods,
    createRecruiteeInfo: createRecruiteeData,
};


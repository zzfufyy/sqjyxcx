// index.js
const recruitee = require("./recruitee");

const { Completer } = require("../../utils/function_util");
const loading = require('../../utils/loading_util');
const $ = require('../../utils/request_util');
const user = require('../../common/user');

// 获取应用实例
const app = getApp();
Page({
  data: {
    ...recruitee.createRecruiteeInfo(),
    topnav: [
      { name: '投递记录', imsrc: '/img/tdjl.png', url: '' },
      { name: '个人简历', imsrc: '/img/grjl.png', url: '' },
      { name: '邀约面试', imsrc: '/img/yyms.png', url: '' },
      { name: '修改定位', imsrc: '/img/xgdw.png', url: '' },
    ],
    isShowEmpower: false,
    animated: false,
    compangjob: [
      {
        companyname: '长沙星沙文和友餐饮文化管理有限公司', companyjuli: '1.2', companylocal: '长沙县泉塘街道新长海广场',
        companytag: [{ tagbq: '店长' }, { tagbq: '楼面经理' }, { tagbq: '楼面领班' }, { tagbq: '服务员' }, { tagbq: '收银员' },]
      },
      {
        companyname: '长沙鸿朗自动化科技有限公司', companyjuli: '1.2', companylocal: '长沙市望城经济技术开发区',
        companytag: [{ tagbq: '机械设计师' }, { tagbq: '装配钳工' }, { tagbq: '装配电工' }]
      },
      {
        companyname: '长沙鸿朗自动化科技有限公司', companyjuli: '1.2', companylocal: '长沙市望城经济技术开发区',
        companytag: [{ tagbq: '机械设计师' }, { tagbq: '装配钳工' }, { tagbq: '装配电工' }]
      },
    ],
    scene: "",
    nianl: [
      { nal: '30-40岁' }, { nal: '40-50岁' }, { nal: '50-60岁' },
    ],
    num2: '',
    wantjob: [
      { job: '保洁', id: 1, }, { job: '服务员', id: 2, }, { job: '保安', id: 3 }, { job: '保姆', id: 4 },
    ],
    xzyq: [
      { xz: '3K-5K' }, { xz: '5K-8K' }, { xz: '8K-10K' },
    ],
    ht: '',
    // 角色选择
    juesehide: true,
    // 实名认证
    smhide: true,
    // 求职者完善信息
    infows: true,
    //企业登录
    qydl: true,
    //提示用户需要获取手机号
    sjh: true,
    isShow: false,
    arrshow: true,
  },

  // 更改定位
  changedw(e) {
    let that = this
    wx.chooseLocation({
      type: 'gcj02',
      success(res) {
        console.log(res)
        const latitude = res.latitude
        const longitude = res.longitude
        var positionData = res.address
        that.setData({
          // positionData:positionData
        })
      }
    })
  },
  //搜索函数
  searchjob() {
    console.log("000")
    this.setData({
      okl: "000"
    })
  },
  //添加意向
  btntjia() {
    wx.navigateTo({
      url: '/pages/wantjob/wantjob',
    })
  },
  //求职者
  qzz() {
    let juesehide = this.data.juesehide
    user.saveUserRole(user.UserRole.Recruitee);

    this.setData({
      juesehide: true,
      smhide: false
    })
  },
  //招聘方
  zpf() {
    let juesehide = this.data.juesehide

    user.saveUserRole(user.UserRole.Recruiter);
    this.setData({
      juesehide: true,
      qydl: false
    })
  },
  //实名认证提交
  smrztijsq() {
    let smhide = this.data.smhide
    this.setData({
      smhide: true,
      infows: false
    })
  },
  //完善信息
  wsxnhide() {
    let infows = this.data.infows
    this.setData({
      infows: true
    })
  },
  //提示用户需要获取手机号*确认*
  getPhoneNumber(e) {
    this.setData({
      sjh: true,
      juesehide: false
    })
  },
  //提示用户需要获取手机号*忽略*
  hulue() {
    this.setData({
      sjh: true,
      // juesehide:false
    })
  },
  // 求职者完善信息start
  // 性别选择

  saveUserInfo: async function (userInfo, iv, signature, encryptedData, rawData, scene) {
    console.log("Starting save user info after auth");

    const that = this;
    console.log(userInfo)
    console.log(iv)
    console.log(signature)
    console.log(encryptedData)
    console.log(rawData)
    console.log(app.globalData.web_path)
    console.log(app.globalData.appId)
    // wx.showLoading({
    //   title: '加载中',
    //   mask: true
    // })
    debugger
    let completer = new Completer();
    wx.login({
      success: completer.resolve,
      fail: completer.reject,
    });
    let r = await completer.promise;

    if (r.code) {
      // 请求登录一次
      let res = await $.request({
        url: '/wx/user/' + app.globalData.appId + '/login',
        data: {
          code: r.code,
          loginType: 'openid'
        },
        header: app.globalData.header,
      });


      //判断是否存在token,不存在则说明该用户没有注册,需要弹出用户登录页面,有则不需要进行页面跳转
      if (!res.data.Token && userInfo) {
        //保存用户信息
        var openid = wx.getStorageSync('openid');

        await $.request({
          url: '/wx/user/' + app.globalData.appId + '/info',
          data: {
            sessionKey: res.data.sessionKey,
            iv: iv,
            signature: signature,
            encryptedData: encryptedData,
            rawData: rawData,
            openid: openid
          },

          header: app.globalData.header,
        });

      } else {
        //放在请求头里
        console.log(111)
        app.globalData.header.Token = res.data.Token
      }
    }else{
      console.error("微信登录失败")
    }
  },

  /**
    * 引导用户授权
    */
  _doAuthorize: function (scene) {
    var that = this;
    //var Token = wx.getStorageSync('Token');

    this._authCompleter = new Completer();

    wx.login({
      success: function (res) {
        that.setData({
          res: res
        })
        wx.request({
          url: app.globalData.web_path + '/wx/user/' + app.globalData.appId + '/login',
          data: {
            code: res.code,
            loginType: 'openid'
          },
          header: app.globalData.header,
          success: function (e) {

            console.log(e);

            //将openid  缓存
            // wx.setStorageSync('openid', res.data.data.openid);
            // wx.setStorageSync('sessionKey', res.data.data.sessionKey);
            // wx.setStorageSync('Token', res.data.data.Token);
            // console.log(JSON.stringify(e.data.data.userWx))

            // 对于没有进行授权的用户，db 中是没有相关数据的
            // 因此，返回的数据中不会包含用户的信息
            if (JSON.stringify(e.data.data.userWx) == undefined) {
              that.setData({
                isShowEmpower: true,
                scene: scene,
                sjh: false,
                animated: true,
              });
            }
            // 对于进行了授权的用户，不需要弹出授权你框
            else {
              //已授权：1.已注册会自动登录 2.已授权但未注册则弹出注册页面
              that.setData({
                isShowEmpower: false,
                sjh: true,
                scene: scene,
                animated: false
              });
            }
          }
        })
      },
    });

    return this._authCompleter.promise;
  },

  setPhone(openid, phone) {
    wx.request({
      url: app.globalData.web_path + '/gywm/setWxuserPhone',
      data: {
        openid: openid,
        phone: phone,
      },
      header: app.globalData.header,
      success: function (res) {
        console.log(res)
        // that.openAlert(scene);
      },
      fail: function (res) {
      }
    })
  },



  //获取微信用户信息
  getUserProfile(e) {

    const scene = this.data.scene;
    var that = this;

    console.log(app.globalData.web_path)
    console.log(app.globalData.appId)
    console.log(e)
    wx.getUserProfile({
      desc: "获取你的昵称、头像、地区及性别", // 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写
      success: (res) => {
        this.setData({
          userInfo: res.userInfo,
        })
        that.saveUserInfo(
          res.userInfo,
          res.iv,
          res.signature,
          res.encryptedData,
          res.rawData,
          scene
        );
      }, fail: (res) => {
        console.log(res);
      },
    });
  },

  // 年龄选择
  nlxz(e) {
    let that = this;
    let index = e.currentTarget.dataset.index2;
    that.setData({
      num2: index
    })
  },
  //想从事的工作
  wanjob(e) {
    let id = e.currentTarget.dataset.id
    console.log(id)
    for (let i = 0; i < this.data.wantjob.length; i++) {
      if (this.data.wantjob[i].id == id) {
        if (this.data.wantjob[i].checked == true) {
          this.data.wantjob[i].checked = false;
        } else {
          this.data.wantjob[i].checked = true;
        }
      }
    }
    this.setData({
      wantjob: this.data.wantjob,
      msg: "id:" + id
    })
  },

  // 求职者完善信息end
  //企业登录
  qydltijsq() {
    let qydl = this.data.qydl
    this.setData({
      qydl: true
    })
  },
  onLoad: async function (options) {
    let that = this

    //自定义头部方法
    this.setData({
      navH: app.globalData.navHeight,
      margtop: app.globalData.navHeight
    });
    this.data.wantjob[0].checked = true;
    this.setData({
      wantjob: this.data.wantjob,
    })
    //设置scroll-view的高度
    console.log(app.globalData.arrij.screenHeight)

    that.setData({
      ht: app.globalData.arrij.screenHeight - 119
    })
    // 获取位置信息
    // wx.getLocation({
    //   type: 'wgs84',
    //   success (res) {
    //     console.log(res)
    //     const latitude = res.latitude
    //     const longitude = res.longitude
    //     const speed = res.speed
    //     const accuracy = res.accuracy
    //   }
    //  })
    await this._doAuthorize();
    // 加载上一次登录的角色信息
    //await this._loadUserRole();
  },

  _loadUserRole: async function () {
    try {
      const value = await user.loadUserRole();
      console.debug(`角色选择缓存为： ${value}`);
      this.setData({
        juesehide: true,
      });
    } catch (_) {
      console.debug("没有角色选择缓存");
      this.setData({
        juesehide: false,
      });
    }
  },

  ...recruitee.createRecruiteeMethods(),
})
